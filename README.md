[![Maintainability](https://api.codeclimate.com/v1/badges/659a72a1faefbcbf7565/maintainability)](https://codeclimate.com/github/ChuanHuoGe/esaasbook/maintainability)
![Build Status](https://github.com/ChuanHuoGe/esaasbook/actions/workflows/main.yml/badge.svg)
[![Test Coverage](https://api.codeclimate.com/v1/badges/659a72a1faefbcbf7565/test_coverage)](https://codeclimate.com/github/ChuanHuoGe/esaasbook/test_coverage)
[![Pivotal Tracker](https://github.com/ChuanHuoGe/esaasbook/blob/master/badge_images/pivotal_tracker_logo.png)](https://www.pivotaltracker.com/n/projects/2553320)
[![Bluejay Dashboard](https://img.shields.io/badge/Bluejay-Dashboard_Interactive_Textbook_for_CS169/ESaaS-blue.svg)](http://dashboard.bluejay.governify.io/dashboard/script/dashboardLoader.js?dashboardURL=https://reporter.bluejay.governify.io/api/v4/dashboards/tpa-CS169L-22-GH-ChuanHuoGe_esaasbook/main)

# ESAASBOOK

## Welcome to the ESAASBOOK repo!
- ESAASBOOK is a Ruby on Rails app ported from the HTML generated by Sphinxbook RSTs.  
- We use [Devise](https://github.com/heartcombo/devise) for authentication.  
- We use the [Recogito.js](https://github.com/recogito/recogito-js) library for highlights/annotations.  


## Setting up the repo

1. Ensure you have the following installed and selected for use:
- Ruby 2.6.6
    - To check your Ruby version you can type `ruby -v` (or `rvm list` if using rvm).
- Rails 6.1.4.6  
    - To check your Rails version you can type `rails -v`


2. Clone the repo and set up your Heroku application


3. Run `bundle install --without production` to install gems


4. Construct the database
    - Run `rails db:migrate` to construct the database
    - Run `heroku rake db:migrate` to migrate on Heroku


5. Seed the database
    - Run `rails db:seed` to populate the DB with necessary seed ddata  
    - Run `heroku rake db:seed` to seed Heroku  


6. Register a github OAuth app
    1.  See [this tutorial](https://docs.github.com/en/developers/apps/building-oauth-apps/creating-an-oauth-app)
        - For deployment on your local machine, use `http://localhost:3000` as your homepage URL and `http://localhost:3000/users/auth/github/callback` as your callback URL
        - For deployment on Heroku use `https://*your heroku app name*.herokuapp.com/` for the homepage and `https://esaas169l.herokuapp.com/users/auth/github/callback` for the callback
    2. Generate a client secret
    3. Make note of your app ID and your client secret


7. Set your Environment variables using Figaro (local) or via Config Vars (Heroku)
    - For local dev: 
        - Run `bundle exec figaro install` to generate Figaro's config file
        - Open your `.gitignore` file and verify that `config/application.yml` is present. Never upload secrets to github!
        - Add the following two lines to your `config/application.yml` file:  
        ```
            GITHUB_APP_ID: (the app id from github)  
            GITHUB_APP_SECRET: (the client secret from github)
        ```
    - For Heroku:
        - Go to your heroku app's dashboard (i.e. `https://dashboard.heroku.com/apps/*your app name*`)
        - Click `Settings`
        - Click `Reveal Config Vars`
        - Add config vars for `GITHUB_APP_ID` and `GITHUB_APP_SECRET` and provide them the values you got from Github


8. You're good to go!

## Advice
Words of advice for the next generation:

- Add rubocop to CI. Rubocop is currenly included in the guardfile, but CI is not currently enforcing it
- Add ESLint or other Javascript linter.
- Add an HTML Linter and lint the html.erb files. Sphinxbook generates really messy HTML - hand linting is not recommended, especially if you are updating the site via RSTs!
- Write more robust javascript tests
- Write a script to automatically extract the book content from the RSTs. At the moment, we are just extracting everything between the `<main></main>` tags. 
- Many items are **manually defined or inserted**:
    - **Images are manually inserted**, they were not generated by the RSTs that the customer provided! Work with the customer to make them get the images working with the RSTs. 
    - Page titles **are manually defined** in the database seeds. If the titles are changed at a higher level you will need to modify the seeds!
        - On the topic of page titles, right now they are all **implemented as fixtures for testing purposes**. Just be aware of this and be prepared to change it to a safer method (proper stubbing)
    - The table of contents was extracted from the RSTs, but then heavily modified to fit the layout that we are using (`/chapter/*number*/section/*number*`)

## Credits
This version of the repository was created by Joshua Delrosario, Sibo Ma, Chris Thomas, and Hellen Wang for CS169L Spring Semester 2022  

Feel free to blame us when something random breaks :) 
